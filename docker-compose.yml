version: '3.8'

services:
  # ============================================
  # MongoDB Database
  # ============================================
  db:
    image: mongo:7
    container_name: saas_mongodb${CONTAINER_SUFFIX:-}
    environment:
      MONGO_INITDB_DATABASE: ${MONGODB_DB_NAME:-saas}
    ports:
      - "${DB_PORT:-27017}:27017"
    volumes:
      - db_data:/data/db
    networks:
      - saas-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # FastAPI Backend
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: saas_backend${CONTAINER_SUFFIX:-}
    environment:
      # MongoDB Configuration
      MONGODB_URI: ${MONGODB_URI:-mongodb://db:27017}
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:-saas}
      
      # JWT Configuration
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-me-in-production}
      JWT_REFRESH_SECRET_KEY: ${JWT_REFRESH_SECRET_KEY:-change-me-refresh-in-production}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      ACCESS_TOKEN_EXP_MINUTES: ${ACCESS_TOKEN_EXP_MINUTES:-30}
      REFRESH_TOKEN_EXP_MINUTES: ${REFRESH_TOKEN_EXP_MINUTES:-10080}
      
      # Application Configuration
      APP_NAME: ${APP_NAME:-SaaS Core API}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      
      # CORS Configuration
      CORS_ORIGINS: ${CORS_ORIGINS:-["http://localhost:3000"]}
      FRONTEND_BASE_URL: ${FRONTEND_BASE_URL:-http://localhost:3000}
      COOKIE_SECURE: ${COOKIE_SECURE:-false}
      COOKIE_SAMESITE: ${COOKIE_SAMESITE:-none}
      
      # OpenAI / AI Agent
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-3.5-turbo}
      OPENAI_TEMPERATURE: ${OPENAI_TEMPERATURE:-0.7}
      
      # Email (SendGrid)
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-no-reply@saas.local}
      
      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      
      # Password Policy
      PASSWORD_MIN_LENGTH: ${PASSWORD_MIN_LENGTH:-12}
      PASSWORD_REQUIRE_SPECIAL: ${PASSWORD_REQUIRE_SPECIAL:-true}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - saas-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/v1/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000

  # ============================================
  # Next.js Frontend
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: saas_frontend${CONTAINER_SUFFIX:-}
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - saas-network
    restart: unless-stopped
    profiles:
      - ${FRONTEND_PROFILE:-full}

  # ============================================
  # Nginx Reverse Proxy (Production)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: saas_nginx${CONTAINER_SUFFIX:-}
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - backend
    networks:
      - saas-network
    restart: unless-stopped
    profiles:
      - ${NGINX_PROFILE:-nginx}

# ============================================
# Networks
# ============================================
networks:
  saas-network:
    driver: bridge
    name: saas-network

# ============================================
# Volumes
# ============================================
volumes:
  db_data:
    name: saas_db_data${VOLUME_SUFFIX:-}
